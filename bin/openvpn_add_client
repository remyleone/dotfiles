#!/bin/sh
# (c) Philippe Bayle
# 2008

cert_path="/etc/ssl/erebor.fr/"
user=""
machine=""

if [ "$#" -eq 0 ] || [ "$1" = "-h"  ] || [ "$1" = "--help" ]
then
	echo "Usage:"
	echo ""
	echo "$0 [-h] | utilisateur machine"
	echo ""
	echo ""
	echo "Script permettant de facilement générer un certificat OpenVPN pour un client"
	echo "-h:		help"
	echo ""
	echo ""
	exit
fi

#--------------------
# argument parsing
#--------------------

# récupération
user=$1
machine=$2

# vérification
id $user >/dev/null 2>&1
if [ $? -ne 0 ] ; then
	echo "Erreur : utilisateur inconnu"
	exit
fi

if [ "$machine" = "" ] ; then
	echo "Erreur : le nom de la machine doit être renseigné"
	exit
fi


couple="${user}_${machine}"

#------------------
# actions
#------------------

echo -n "[32;1m"
echo "====================================================="
echo "Création de certificat OpenVPN pour ${user}"
echo "Nom de la machine : ${machine}"
echo "====================================================="
echo "[0m"

echo ""
echo "déplacement dans le répertoire des certificats"
echo ""
cd $cert_path

echo ""
echo "génération du certificat..."
echo ""
openssl req -newkey rsa:1024 -nodes -keyout private/${couple}.key -out ${couple}.req
openssl ca -in ${couple}.req -out certs/${couple}.crt

echo ""
echo "nettoyage et mise en place du couple certificat/clé dans le répertoire de l'utilisateur..."
echo ""
rm ${couple}.req
install -m600 -o${user} certs/${couple}.crt private/${couple}.key /home/${user}


cd - >/dev/null
